<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cùng Xem Video Và Chat</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.youtube.com/iframe_api"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f5f5f5;
        }
        
        #video-container {
            position: relative;
            padding-bottom: 56.25%; /* 16:9 aspect ratio */
            height: 0;
            overflow: hidden;
        }
        
        #youtube-player, #custom-video {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        
        .message-current-user {
            background-color: #3b82f6;
            color: white;
            border-radius: 1rem 1rem 0 1rem;
        }
        
        .message-other-user {
            background-color: #e5e7eb;
            color: #1f2937;
            border-radius: 1rem 1rem 1rem 0;
        }
        
        @media (max-width: 768px) {
            .main-container {
                flex-direction: column;
            }
            .chat-container {
                max-height: 300px;
                border-left: none;
                border-top: 1px solid #e5e7eb;
            }
        }
        
        .loading-spinner {
            border: 3px solid rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            border-top: 3px solid #3b82f6;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">
    <header class="bg-white shadow-sm py-4 px-6">
        <h1 class="text-2xl font-bold text-blue-600">Cùng Xem Video Và Chat</h1>
        <div id="connection-status" class="text-sm flex items-center gap-1">
            <div class="w-2 h-2 rounded-full bg-red-500"></div>
            <span>Đang kết nối...</span>
        </div>
    </header>

    <div class="flex-1 p-4 main-container flex flex-col md:flex-row max-w-6xl mx-auto w-full gap-4">
        <!-- Video Section -->
        <div class="flex-1 bg-white rounded-lg shadow-sm overflow-hidden">
            <div class="p-4 border-b border-gray-200">
                <h2 class="text-lg font-semibold">Trình phát video</h2>
                <div class="flex items-center gap-2 mt-2">
                    <div class="relative flex-1">
                        <input type="text" id="video-url" placeholder="Dán link YouTube hoặc MP4/WebM" 
                            class="w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <button id="load-video-btn" class="absolute right-2 top-1/2 transform -translate-y-1/2 bg-blue-500 text-white px-3 py-1 rounded-lg hover:bg-blue-600 transition flex items-center gap-1">
                            <span>Tải</span>
                            <div id="video-loading" class="loading-spinner hidden"></div>
                        </button>
                    </div>
                </div>
            </div>
            
            <div id="video-player" class="p-4">
                <div id="video-container">
                    <div id="youtube-player"></div>
                    <video id="custom-video" controls style="display: none;"></video>
                </div>
                
                <div class="flex justify-center gap-4 mt-4">
                    <button id="play-btn" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd" />
                        </svg>
                        Phát
                    </button>
                    <button id="pause-btn" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-300 transition flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zM7 8a1 1 0 012 0v4a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v4a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                        </svg>
                        Tạm dừng
                    </button>
                </div>
                
                <div class="flex items-center justify-between mt-2">
                    <span id="current-time" class="text-sm text-gray-500">0:00</span>
                    <span id="duration" class="text-sm text-gray-500">0:00</span>
                </div>
                <input type="range" id="progress-bar" min="0" max="100" value="0" class="w-full mt-2 h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
            </div>
        </div>
        
        <!-- Chat Section -->
        <div class="w-full md:w-80 bg-white rounded-lg shadow-sm overflow-hidden flex flex-col chat-container">
            <div class="p-4 border-b border-gray-200">
                <h2 class="text-lg font-semibold">Trò chuyện</h2>
                <div class="mt-2">
                    <input type="text" id="username" placeholder="Tên của bạn" class="w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
            </div>
            
            <div id="chat-messages" class="flex-1 p-4 overflow-y-auto space-y-3">
                <p class="text-sm text-gray-500 text-center">Bắt đầu trò chuyện khi xem video cùng nhau</p>
            </div>
            
            <div class="p-4 border-t border-gray-200">
                <div class="flex gap-2">
                    <input type="text" id="message-input" placeholder="Nhắn tin..." class="flex-1 p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <button id="send-btn" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition flex items-center gap-1">
                        <span>Gửi</span>
                        <div id="message-loading" class="loading-spinner hidden"></div>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // WebSocket Configuration
        const wsProtocol = window.location.protocol === 'https:' ? 'wss://' : 'ws://';
        const wsHost = window.location.host;
        const wsPath = '/ws'; // You'll need to set up a WebSocket server
        const wsUrl = wsProtocol + wsHost + wsPath;
        
        // Fallback server for demo purposes (replace with your own server)
        const fallbackWsUrl = 'wss://socketsbay.com/wss/v2/1/demo/';
        
        let socket;
        let reconnectAttempts = 0;
        const maxReconnectAttempts = 5;
        const reconnectDelay = 3000; // 3 seconds
        
        // DOM Elements
        const videoUrlInput = document.getElementById('video-url');
        const loadVideoBtn = document.getElementById('load-video-btn');
        const playBtn = document.getElementById('play-btn');
        const pauseBtn = document.getElementById('pause-btn');
        const progressBar = document.getElementById('progress-bar');
        const currentTimeDisplay = document.getElementById('current-time');
        const durationDisplay = document.getElementById('duration');
        const chatMessages = document.getElementById('chat-messages');
        const messageInput = document.getElementById('message-input');
        const sendBtn = document.getElementById('send-btn');
        const usernameInput = document.getElementById('username');
        const connectionStatus = document.getElementById('connection-status');
        const videoLoading = document.getElementById('video-loading');
        const messageLoading = document.getElementById('message-loading');
        
        // Video State
        let player;
        let customVideo;
        let currentVideoType = null; // 'youtube' or 'custom'
        let isSyncing = false;
        let lastSyncTime = 0;
        const syncInterval = 2000; // Sync every 2 seconds
        
        // Initialize YouTube Player
        function onYouTubeIframeAPIReady() {
            player = new YT.Player('youtube-player', {
                height: '100%',
                width: '100%',
                events: {
                    'onReady': onPlayerReady,
                    'onStateChange': onPlayerStateChange
                }
            });
        }
        
        function onPlayerReady(event) {
            console.log("YouTube player is ready");
        }
        
        function onPlayerStateChange(event) {
            if (isSyncing) return;
            
            const currentTime = player.getCurrentTime();
            const videoId = player.getVideoData().video_id;
            const isPlaying = event.data === YT.PlayerState.PLAYING;
            
            syncVideoState({
                type: 'youtube',
                videoId: videoId,
                currentTime: currentTime,
                isPlaying: isPlaying,
                timestamp: Date.now()
            });
            
            updateProgressBar();
        }
        
        // Initialize Custom Video
        customVideo = document.getElementById('custom-video');
        
        customVideo.addEventListener('play', () => {
            if (isSyncing) return;
            syncVideoState({
                type: 'custom',
                videoUrl: customVideo.src,
                currentTime: customVideo.currentTime,
                isPlaying: true,
                timestamp: Date.now()
            });
        });
        
        customVideo.addEventListener('pause', () => {
            if (isSyncing) return;
            syncVideoState({
                type: 'custom',
                videoUrl: customVideo.src,
                currentTime: customVideo.currentTime,
                isPlaying: false,
                timestamp: Date.now()
            });
        });
        
        customVideo.addEventListener('seeked', () => {
            if (isSyncing) return;
            syncVideoState({
                type: 'custom',
                videoUrl: customVideo.src,
                currentTime: customVideo.currentTime,
                isPlaying: !customVideo.paused,
                timestamp: Date.now()
            });
        });
        
        customVideo.addEventListener('timeupdate', updateProgressBar);
        
        // Connect to WebSocket
        function connectWebSocket() {
            try {
                socket = new WebSocket(wsUrl);
                
                socket.onopen = () => {
                    console.log('WebSocket connected');
                    reconnectAttempts = 0;
                    updateConnectionStatus(true);
                    
                    // Request current state from server
                    sendWebSocketMessage({
                        type: 'get_state'
                    });
                };
                
                socket.onclose = () => {
                    console.log('WebSocket disconnected');
                    updateConnectionStatus(false);
                    attemptReconnect();
                };
                
                socket.onerror = (error) => {
                    console.error('WebSocket error:', error);
                    updateConnectionStatus(false);
                };
                
                socket.onmessage = (event) => {
                    try {
                        const data = JSON.parse(event.data);
                        handleWebSocketMessage(data);
                    } catch (e) {
                        console.error('Error parsing WebSocket message:', e);
                    }
                };
                
            } catch (e) {
                console.error('WebSocket connection failed:', e);
                attemptReconnect();
            }
        }
        
        function attemptReconnect() {
            if (reconnectAttempts < maxReconnectAttempts) {
                reconnectAttempts++;
                console.log(`Attempting to reconnect (${reconnectAttempts}/${maxReconnectAttempts})...`);
                setTimeout(connectWebSocket, reconnectDelay);
            } else {
                console.log('Max reconnection attempts reached. Using fallback server.');
                useFallbackServer();
            }
        }
        
        function useFallbackServer() {
            console.log('Connecting to fallback WebSocket server');
            try {
                socket = new WebSocket(fallbackWsUrl);
                
                socket.onopen = () => {
                    console.log('Connected to fallback server');
                    updateConnectionStatus(true);
                };
                
                socket.onclose = () => {
                    console.log('Fallback server disconnected');
                    updateConnectionStatus(false);
                };
                
                socket.onerror = (error) => {
                    console.error('Fallback server error:', error);
                    updateConnectionStatus(false);
                };
                
                socket.onmessage = (event) => {
                    try {
                        const data = JSON.parse(event.data);
                        handleWebSocketMessage(data);
                    } catch (e) {
                        console.error('Error parsing fallback message:', e);
                    }
                };
                
            } catch (e) {
                console.error('Fallback server connection failed:', e);
                updateConnectionStatus(false);
            }
        }
        
        function updateConnectionStatus(connected) {
            const statusDot = connectionStatus.querySelector('div');
            const statusText = connectionStatus.querySelector('span');
            
            if (connected) {
                statusDot.className = 'w-2 h-2 rounded-full bg-green-500';
                statusText.textContent = 'Đã kết nối';
            } else {
                statusDot.className = 'w-2 h-2 rounded-full bg-red-500';
                statusText.textContent = `Mất kết nối (${reconnectAttempts}/${maxReconnectAttempts})`;
            }
        }
        
        function sendWebSocketMessage(message) {
            if (socket && socket.readyState === WebSocket.OPEN) {
                socket.send(JSON.stringify(message));
            } else {
                console.warn('WebSocket is not connected. Message not sent:', message);
            }
        }
        
        function handleWebSocketMessage(data) {
            if (!data) return;
            
            switch (data.type) {
                case 'video_state':
                    handleVideoState(data);
                    break;
                case 'chat_message':
                    handleChatMessage(data);
                    break;
                case 'system_message':
                    showSystemMessage(data.message);
                    break;
                case 'current_state':
                    if (data.video) handleVideoState(data.video);
                    if (data.messages) {
                        chatMessages.innerHTML = '';
                        data.messages.forEach(msg => {
                            handleChatMessage(msg);
                        });
                    }
                    break;
                default:
                    console.log('Unknown message type:', data.type);
            }
        }
        
        function handleVideoState(state) {
            if (!state || isSyncing) return;
            
            isSyncing = true;
            const currentUsername = usernameInput.value.trim() || 'Ẩn danh';
            
            try {
                if (state.type === 'youtube') {
                    // Switch to YouTube player if needed
                    if (currentVideoType !== 'youtube') {
                        document.getElementById('youtube-player').style.display = 'block';
                        customVideo.style.display = 'none';
                        currentVideoType = 'youtube';
                    }
                    
                    // Load video if different
                    if (player.getVideoData().video_id !== state.videoId) {
                        player.loadVideoById(state.videoId);
                    }
                    
                    // Sync playback state
                    if (state.isPlaying) {
                        player.playVideo();
                        showSystemMessage(`${state.username || 'Ai đó'} đã nhấn phát video`);
                    } else {
                        player.pauseVideo();
                        showSystemMessage(`${state.username || 'Ai đó'} đã nhấn tạm dừng`);
                    }
                    
                    // Sync time if needed
                    const currentTime = player.getCurrentTime();
                    if (Math.abs(currentTime - state.currentTime) > 2) {
                        player.seekTo(state.currentTime, true);
                    }
                    
                } else if (state.type === 'custom') {
                    // Switch to custom video if needed
                    if (currentVideoType !== 'custom') {
                        document.getElementById('youtube-player').style.display = 'none';
                        customVideo.style.display = 'block';
                        currentVideoType = 'custom';
                    }
                    
                    // Load video if different
                    if (customVideo.src !== state.videoUrl) {
                        customVideo.src = state.videoUrl;
                        customVideo.load();
                    }
                    
                    // Sync playback state
                    if (state.isPlaying) {
                        customVideo.play();
                        showSystemMessage(`${state.username || 'Ai đó'} đã nhấn phát video`);
                    } else {
                        customVideo.pause();
                        showSystemMessage(`${state.username || 'Ai đó'} đã nhấn tạm dừng`);
                    }
                    
                    // Sync time if needed
                    if (Math.abs(customVideo.currentTime - state.currentTime) > 2) {
                        customVideo.currentTime = state.currentTime;
                    }
                }
                
                lastSyncTime = Date.now();
                
            } catch (e) {
                console.error('Error handling video state:', e);
            } finally {
                setTimeout(() => {
                    isSyncing = false;
                }, 500);
            }
        }
        
        function handleChatMessage(message) {
            if (!message || !message.text) return;
            
            const currentUsername = usernameInput.value.trim() || 'Ẩn danh';
            const isCurrentUser = message.username === currentUsername;
            
            addMessageToChat(message.username, message.text, isCurrentUser);
        }
        
        function syncVideoState(state) {
            if (!state) return;
            
            state.username = usernameInput.value.trim() || 'Ẩn danh';
            state.timestamp = Date.now();
            
            sendWebSocketMessage({
                type: 'video_state',
                ...state
            });
        }
        
        function updateProgressBar() {
            if (!currentVideoType) return;
            
            let currentTime, duration;
            
            if (currentVideoType === 'youtube' && player && player.getCurrentTime) {
                currentTime = player.getCurrentTime();
                duration = player.getDuration();
            } else if (currentVideoType === 'custom' && customVideo) {
                currentTime = customVideo.currentTime;
                duration = customVideo.duration;
            } else {
                return;
            }
            
            const progress = (currentTime / duration) * 100;
            progressBar.value = progress;
            
            // Update time displays
            currentTimeDisplay.textContent = formatTime(currentTime);
            
            if (!isNaN(duration)) {
                durationDisplay.textContent = formatTime(duration);
            } else {
                durationDisplay.textContent = "0:00";
            }
            
            // Periodically sync video state
            const now = Date.now();
            if (now - lastSyncTime > syncInterval && !isSyncing) {
                if (currentVideoType === 'youtube') {
                    syncVideoState({
                        type: 'youtube',
                        videoId: player.getVideoData().video_id,
                        currentTime: player.getCurrentTime(),
                        isPlaying: player.getPlayerState() === YT.PlayerState.PLAYING
                    });
                } else if (currentVideoType === 'custom') {
                    syncVideoState({
                        type: 'custom',
                        videoUrl: customVideo.src,
                        currentTime: customVideo.currentTime,
                        isPlaying: !customVideo.paused
                    });
                }
            }
        }
        
        function formatTime(seconds) {
            const minutes = Math.floor(seconds / 60);
            seconds = Math.floor(seconds % 60);
            return `${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
        }
        
        // Load Video Function
        loadVideoBtn.addEventListener('click', loadVideo);
        videoUrlInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') loadVideo();
        });
        
        function loadVideo() {
            const url = videoUrlInput.value.trim();
            if (!url) {
                alert("Vui lòng nhập link video");
                return;
            }
            
            videoLoading.classList.remove('hidden');
            
            // Reset previous video
            if (currentVideoType === 'youtube') {
                document.getElementById('youtube-player').style.display = 'none';
                player.stopVideo();
            } else if (currentVideoType === 'custom') {
                customVideo.style.display = 'none';
                customVideo.pause();
                customVideo.src = '';
            }
            
            // Check if YouTube video
            const youtubeRegex = /^(https?:\/\/)?(www\.)?(youtube\.com|youtu\.?be)\/.+$/;
            if (youtubeRegex.test(url)) {
                // Extract YouTube video ID
                let videoId = '';
                const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/;
                const match = url.match(regExp);
                
                if (match && match[2].length === 11) {
                    videoId = match[2];
                } else {
                    alert('Không tìm thấy ID video YouTube trong đường dẫn này');
                    videoLoading.classList.add('hidden');
                    return;
                }
                
                // Load YouTube video
                try {
                    player.loadVideoById(videoId);
                    player.playVideo();
                    document.getElementById('youtube-player').style.display = 'block';
                    currentVideoType = 'youtube';
                    
                    // Sync with other users
                    syncVideoState({
                        type: 'youtube',
                        videoId: videoId,
                        currentTime: 0,
                        isPlaying: true
                    });
                    
                    showSystemMessage('Video YouTube đã được tải, thưởng thức cùng mọi người!');
                } catch (e) {
                    alert('Lỗi khi tải video YouTube: ' + e.message);
                } finally {
                    videoLoading.classList.add('hidden');
                }
            } else {
                // Assume it's a direct video URL
                try {
                    customVideo.src = url;
                    customVideo.load();
                    customVideo.style.display = 'block';
                    currentVideoType = 'custom';
                    
                    // Sync with other users
                    syncVideoState({
                        type: 'custom',
                        videoUrl: url,
                        currentTime: 0,
                        isPlaying: true
                    });
                    
                    showSystemMessage('Video trực tiếp đã được tải, thưởng thức cùng mọi người!');
                } catch (e) {
                    alert('Lỗi khi tải video trực tiếp: ' + e.message);
                } finally {
                    videoLoading.classList.add('hidden');
                }
            }
        }
        
        // Video Controls
        playBtn.addEventListener('click', () => {
            if (currentVideoType === 'youtube' && player && player.playVideo) {
                player.playVideo();
            } else if (currentVideoType === 'custom' && customVideo) {
                customVideo.play();
            }
        });
        
        pauseBtn.addEventListener('click', () => {
            if (currentVideoType === 'youtube' && player && player.pauseVideo) {
                player.pauseVideo();
            } else if (currentVideoType === 'custom' && customVideo) {
                customVideo.pause();
            }
        });
        
        progressBar.addEventListener('input', () => {
            if (!currentVideoType) return;
            
            const seekTime = (progressBar.value / 100) * getCurrentVideoDuration();
            
            if (currentVideoType === 'youtube' && player && player.seekTo) {
                player.seekTo(seekTime, true);
            } else if (currentVideoType === 'custom' && customVideo) {
                customVideo.currentTime = seekTime;
            }
        });
        
        function getCurrentVideoDuration() {
            if (currentVideoType === 'youtube' && player && player.getDuration) {
                return player.getDuration();
            } else if (currentVideoType === 'custom' && customVideo && !isNaN(customVideo.duration)) {
                return customVideo.duration;
            }
            return 0;
        }
        
        // Chat Functionality
        sendBtn.addEventListener('click', sendMessage);
        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendMessage();
        });
        
        function sendMessage() {
            const message = messageInput.value.trim();
            const username = usernameInput.value.trim() || 'Ẩn danh';
            
            if (!message) {
                alert("Vui lòng nhập tin nhắn");
                return;
            }
            
            if (!username) {
                alert("Vui lòng nhập tên của bạn");
                return;
            }
            
            messageLoading.classList.remove('hidden');
            
            sendWebSocketMessage({
                type: 'chat_message',
                username: username,
                text: message,
                timestamp: Date.now()
            });
            
            messageInput.value = '';
            messageLoading.classList.add('hidden');
        }
        
        function showSystemMessage(text) {
            const messageElement = document.createElement('p');
            messageElement.className = 'text-sm text-gray-500 text-center';
            messageElement.textContent = text;
            chatMessages.appendChild(messageElement);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        function addMessageToChat(username, text, isCurrentUser) {
            const messageDiv = document.createElement('div');
            messageDiv.className = isCurrentUser ? 'message-current-user' : 'message-other-user';
            messageDiv.className += ' p-3 max-w-xs md:max-w-md';
            
            const usernameSpan = document.createElement('span');
            usernameSpan.className = 'font-semibold text-xs block mb-1';
            usernameSpan.textContent = username;
            
            const textSpan = document.createElement('span');
            textSpan.className = 'text-sm';
            textSpan.textContent = text;
            
            messageDiv.appendChild(usernameSpan);
            messageDiv.appendChild(textSpan);
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        // Initialize
        connectWebSocket();
        usernameInput.focus();
        
        // Periodically check connection
        setInterval(() => {
            if (!socket || socket.readyState !== WebSocket.OPEN) {
                updateConnectionStatus(false);
            }
        }, 5000);
    </script>
</body>
</html>
